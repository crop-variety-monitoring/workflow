---
title: "Matching methods comparison"
date: "Compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    code_folding: hide
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

this <- system("hostname", TRUE)
if (this == "LAPTOP-IVSPBGCA") { 
	dpath <- "G:/.shortcut-targets-by-id/1mfeEftF_LgRcxOT98CBIaBbYN4ZHkBr_/share/image"
} else if (this == "DESKTOP-M2BA7AA") {
	dpath <- "google drive path"
}
```


```{r fileread, include=FALSE, cache=TRUE}
fdap <- list.files(file.path(dpath, "output/DAP"), pattern="xlsx$", recursive=TRUE, full=TRUE)
fdap <- fdap[!grepl("~", fdap)]
fdap <- fdap[!grepl("ETH", fdap)]

fibs <- gsub("DAP", "IBS", fdap)

ibs <- lapply(fibs, \(f) readxl::read_excel(f, "IBS_variety") |> data.frame())
dap <- lapply(fdap, \(f) {
    x <- readxl::read_excel(f, "res_full") |> data.frame()
    tab <- table(x$field_id[x$var_rank==1])
    exclude <- names(tab[tab>10])
    if (!is.null(exclude)) {
    	x <- x[!(x$field_id %in% exclude), ]
    }
    x
})

orders <- gsub("_IBS.xlsx", "", basename(fibs))
onms <- matchpoint:::order_names()
olabs <- onms$cc[match(orders, onms$name)]

get1 <- function(x) {
  x <- x[x$var_rank == 1, ]
  x$var_rank <- NULL
  x
}
ibs1 <- lapply(ibs, get1)
dap1 <- lapply(dap, get1)

d <- lapply(1:length(dap), \(i) merge(ibs[[i]], dap[[i]], by=c("field_id", "ref_id")))
d1 <- lapply(1:length(dap), \(i) merge(ibs1[[i]], dap1[[i]], by="field_id"))
```

## Introduction

So far, we have two matching methods: IBS and DAP. Here we compare the results obtained with these methods. Right now we can compare the data for `r length(orders)` orders.

## Matches 

Best matches 

```{r prep_matches_tab1}
i <- lapply(ibs1, \(x) {
  x <- as.data.frame(table(x$variety))
  colnames(x) <- c("variety", "IBS")
  x
})
j <- lapply(dap1, \(x) {
  x <- as.data.frame(table(x$variety))
  colnames(x) <- c("variety", "DAP")
  x
})

k <- lapply(1:length(i), \(p) {
    m <- merge(i[[p]], j[[p]], by="variety", all=TRUE)
    m[is.na(m)] <- 0
    m[rev(order(m$IBS)), ]
})
```


<div class = "row">
<div class = "col-md-5">
```{r tab1}
cap <- paste0("varieties (", olabs[1] ,")")
kableExtra::kbl(k[[1]], caption=cap) |> kableExtra::kable_classic(full_width = F,  position = "right") |> kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))  |> kableExtra::scroll_box(width = "100%", height = "400px")
```
</div>
<div class = "col-md-5">
```{r tab2}
cap <- paste0("varieties (", olabs[2] ,")")
kableExtra::kbl(k[[2]], caption=cap) |> kableExtra::kable_classic(full_width = F,  position = "right") |> kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))  |> kableExtra::scroll_box(width = "100%", height = "400px")
```
</div></div>


Best matches for IBS>0.7 and DAP>0.5 

```{r matches_tab2}
i <- lapply(ibs1, \(x) {
  x <- as.data.frame(table(x$variety[x$IBS >0.7]))
  colnames(x) <- c("variety", "IBS")
  x
})
j <- lapply(dap1, \(x) {
  x <- as.data.frame(table(x$variety[x$Probability>0.5]))
  colnames(x) <- c("variety", "DAP")
  x
})

k <- lapply(1:length(i), \(p) {
    m <- merge(i[[p]], j[[p]], by="variety", all=TRUE)
    m[is.na(m)] <- 0
    cap <- paste0("varieties (", olabs[p] ,")")
    knitr::kable(m, caption=cap) |> 
          kableExtra::kable_styling(full_width = FALSE)
      })
```


## Comparing the best matches

What is the fraction of the field samples where both methods assign the same reference variety?

```{r matchall}
maketab <- function(tabs) {
  tabs <- do.call(rbind, tabs)
  tabs <- round(tabs / rowSums(tabs), 2)
  rownames(tabs) <- olabs
  colnames(tabs) <- c("no", "yes")[as.logical(colnames(tabs)) + 1]
  knitr::kable(tabs, caption="(Dis-) agreement") |> 
    kableExtra::kable_styling(full_width = FALSE)
}
lapply(d1, \(x) table(x$variety.x == x$variety.y)) |> maketab()

```

How many of the matches match; only considering good matches (IBS > 0.7)?

```{r matchhigh}
lapply(d1, \(x) { x <- x[x$IBS > .7, ]; 
          table(x$variety.x == x$variety.y) }) |> maketab()

```

What is the rank in one method, for the best match in another method?

```{r pressure, echo=FALSE, fig.with=12}
rank_plot <- function(z, add=FALSE, main="") {
	M = c("IBS", "DAP")
	#z$var_rank[is.na(z$var_rank)] <- max(z$var_rank, na.rm=TRUE)
	z <- na.omit(z)
	if (add) {
		lines(sort(z$var_rank), (1:nrow(z))/nrow(z), lwd=2, col="red")	
		legend("bottomright", legend=paste(rev(M), "#1, ranked by", M), col=c("blue", "red"), lwd=2)
	} else {
		plot(sort(z$var_rank), (1:nrow(z))/nrow(z), xlab="Rank by other algorithm", 
			ylab="fraction of samples", las=1, type="l", lwd=2, col="blue", main=main)
	}
}
n <- length(dap1)
par(mfrow=c(1, n))
for (i in 1:n) {
   z1 <- merge(dap1[[i]], ibs[[i]], by=c("field_id", "variety"), all.x=TRUE)
   z2 <- merge(ibs1[[i]], dap[[i]], by=c("field_id", "variety"), all.x=TRUE)
   rank_plot(z1, main=gsub("_IBS.xlsx", "", orders[i]))
   rank_plot(z2, TRUE)
}

```


What is the correlation between all values?

```{r cor, fig.width=12, fig.height=12}
par(mfrow=c(2, 2), mar=c(4, 4, 3, 1))
s <- sapply(1:length(d), \(i) {
 x <- d[[i]]

 plot(x$IBS, x$Probability, cex=.25, main=olabs[i], xlab="IBS", ylab="DAP", las=1, col=rgb(1, 0, 0, .25))
 
 plot(x$var_rank.x, x$var_rank.y, cex=.25, main=olabs[i], xlab="IBS rank", ylab="DAP rank", las=1, col=rgb(0, 0, 1, .25))
 
 c(cor(x$IBS, x$Probability, use="pairwise.complete.obs"),
 cor(x$var_rank.x, x$var_rank.y, method = "spearman",
       use="pairwise.complete.obs")) })
rownames(s) <- olabs
colnames(s) <- c("cor", "rank-cor")
knitr::kable(s, caption="Correlation") |> 
    kableExtra::kable_styling(full_width = FALSE)

```

