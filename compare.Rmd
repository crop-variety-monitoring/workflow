---
title: "Matching methods comparison"
date: "Compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    code_folding: hide
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

this <- system("hostname", TRUE)
if (this == "LAPTOP-IVSPBGCA") { 
	dpath <- "G:/.shortcut-targets-by-id/1mfeEftF_LgRcxOT98CBIaBbYN4ZHkBr_/share/image"
} else if (this == "DESKTOP-M2BA7AA") {
	dpath <- "google drive path"
}

scrolltab <- function(data, caption) {
kableExtra::kbl(data, caption=caption) |>
    kableExtra::kable_classic(full_width = F,  position = "right") |>
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))  |> 
    kableExtra::scroll_box(width = "100%", height = "400px")
}

```


```{r fileread, include=FALSE, cache=TRUE}
fdap <- list.files(file.path(dpath, "output/DAP"), pattern="xlsx$", recursive=TRUE, full=TRUE)
fdap <- fdap[!grepl("~", fdap)]
fdap <- fdap[!grepl("ETH", fdap)]

fibs <- gsub("DAP", "IBS", fdap)
#fham <- gsub("DAP", "HAM", fdap)

ibs <- lapply(fibs, \(f) readxl::read_excel(f, "IBS_variety") |> data.frame())
dap <- lapply(fdap, \(f) {
    x <- readxl::read_excel(f, "res_full") |> data.frame()
    tab <- table(x$field_id[x$var_rank==1])
    exclude <- names(tab[tab>10])
    if (!is.null(exclude)) {
    	x <- x[!(x$field_id %in% exclude), ]
    }
    x
})
#ham <- lapply(fham, \(f) readxl::read_excel(f, "HAM_variety") |> data.frame())


orders <- gsub("_IBS.xlsx", "", basename(fibs))
onms <- matchpoint:::order_names()
olabs <- onms$cc[match(orders, onms$name)]

get1 <- function(x) {
  x <- x[x$var_rank == 1, ]
  x$var_rank <- NULL
  x
}
ibs1 <- lapply(ibs, get1)
dap1 <- lapply(dap, get1)

d <- lapply(1:length(dap), \(i) merge(ibs[[i]], dap[[i]], by=c("field_id", "ref_id")))
d1 <- lapply(1:length(dap), \(i) merge(ibs1[[i]], dap1[[i]], by="field_id"))
```

## Introduction

So far, we have two matching methods: IBS and DAP. Here we compare the results obtained with these methods. Right now we can compare the data for `r length(orders)` orders.

## Distribution of best match scores 

```{r match_scores, fig.width=8, fig.height=4.5}
par(mfrow=c(1, 2))
for (i in 1:2) {
x <- (1:nrow(d1[[i]]))/nrow(d1[[i]])
plot(x, sort(d1[[i]]$IBS), xlab="Fraction of samples", ylab="score", las=1, ylim=c(0.5, 1), type="l", lwd=2, col="blue", main=olabs[i])
grid()
lines(x, sort(d1[[i]]$Probability), col="red", lwd=2)
if (i==1) {
  legend("topleft", legend=c("IBS", "DAP"), lwd=2, col=c("blue", "red"), cex=.9)
}
}


```

## Comparing the best matches

What is the fraction of the field samples where both methods assign the same reference variety? Only considering cases with (IBS >= 0.8)?

```{r match_high}
maketab <- function(tabs) {
  tabs <- do.call(rbind, tabs)
  tabs <- round(tabs / rowSums(tabs), 2)
  rownames(tabs) <- olabs
  colnames(tabs) <- c("different", "same")[as.logical(colnames(tabs)) + 1]
  knitr::kable(tabs, caption="") |> 
    kableExtra::kable_styling(full_width = FALSE)
}

lapply(d1, \(x) { x <- x[x$IBS >= .8, ]; 
          table(x$variety.x == x$variety.y) }) |> maketab()

```

Given match of a field sample to a reference sample in one method; what is the rank of that reference sample in other methods? (only for IBS >= 0.8)

```{r pressure, fig.width=8, fig.height=4}
rank_plot <- function(z, add=FALSE, main="") {
	M = c("IBS", "DAP")
	#z$var_rank[is.na(z$var_rank)] <- max(z$var_rank, na.rm=TRUE)
	z <- na.omit(z)
	if (add) {
		lines(sort(z$var_rank), (1:nrow(z))/nrow(z), lwd=2, col="red")
		legend("bottomright", legend=paste(rev(M), "#1, ranked by", M),
		       col=c("blue", "red"), lwd=c(4,2), cex=.75)
	} else {
		plot(sort(z$var_rank), (1:nrow(z))/nrow(z), 
		     xlab="Rank by other algorithm", 
			   ylab="fraction of samples", axes=FALSE,
			   xlim=c(0, 10), yaxs="i", xaxs="i",
			   las=1, type="l", lwd=4, col="blue", main=main)
	   axis(1, 0:10)
	   axis(2, (0:10)/10, las=1)
	   grid(10,10)
	  grid()
	}
}
n <- length(dap1)
par(mfrow=c(1, n))
for (i in 1:n) {
   ib <- ibs[[i]]
   ib <- ib[ib$IBS >= 0.8, ]
   ib1 <- ibs1[[i]]
   ib1 <- ib1[ib1$IBS >= 0.8, ]
   z1 <- merge(dap1[[i]], ib, by=c("field_id", "variety"), all.x=TRUE)
   z2 <- merge(ib1, dap[[i]], by=c("field_id", "variety"), all.x=TRUE)
   rank_plot(z1, main=olabs[i])
   rank_plot(z2, TRUE)
}

```


What is the correlation between all values (only for IBS >= 0.8)?

```{r cor, fig.width=8, fig.height=8}
par(mfrow=c(2, 2), mar=c(4, 4, 3, 1))
s <- sapply(1:length(d), \(i) {
 x <- d[[i]]
 x <- x[x$IBS >= 0.8, ]  
 plot(x$IBS, x$Probability, cex=1.5, main=olabs[i], xlab="IBS",
      ylab="DAP", las=1, col=rgb(1, 0, 0, .25), pch=20)
 
 plot(x$var_rank.x, x$var_rank.y, cex=1.5, main=olabs[i], 
      xlab="IBS rank", ylab="DAP rank", las=1, 
      col=rgb(0, 0, 1, .25), pch=20)
 
 c(cor(x$IBS, x$Probability, use="pairwise.complete.obs"),
 cor(x$var_rank.x, x$var_rank.y, method = "spearman",
       use="pairwise.complete.obs")) 
 })

rownames(s) <- olabs
colnames(s) <- c("cor", "rank-cor")
s <- round(s, 3)
knitr::kable(s, caption="Correlation") |> 
    kableExtra::kable_styling(full_width = FALSE)

```


Correlation by IBS cut-off

```{r varcor, fig.width=8, fig.height=3.5}
coffs <- seq(0.5, 0.95, .05)
s <- lapply(1:length(d), \(i) {
 x <- d[[i]]
 sapply(1:length(coffs), \(j) {
    x <- x[x$IBS >= coffs[j], ]  
    c(cor(x$IBS, x$Probability, use="pairwise.complete.obs"),
    cor(x$var_rank.x, x$var_rank.y, method = "spearman",
       use="pairwise.complete.obs")) 
 }) |> t()
})


par(mfrow=c(1, 2), mar=c(4, 4, 3, 1))
for (i in 1:2) {
  plot(coffs, s[[i]][,1], main=olabs[i], 
        xlab="IBS cut-off", 
       ylab="correlation IBS & DAP",
       ylim=c(floor(min(s[[i]] * 10))/10, 1),
       col="blue", pch=20, type="b", las=1)
  lines(coffs, s[[i]][,2], type="b", col="red")

  if (i == 1) {
		legend("bottomleft", 
		       legend=c("IBS", "DAP"), lwd=2, 
		       col=c("blue", "red"), cex=.75)
  }
}
```


## Varieties 

Each dot is the number of calls for a reference variety by either method. The line is *y=x* (where you would want the dots to be).

```{r besties, fig.width=8, fig.height=4.5}
i <- lapply(ibs1, \(x) {
  x <- as.data.frame(table(x$variety[x$IBS >0.8]))
  colnames(x) <- c("variety", "IBS")
  x
})
j <- lapply(dap1, \(x) {
  x <- as.data.frame(table(x$variety))
  colnames(x) <- c("variety", "DAP")
  x
})

k <- lapply(1:length(i), \(p) {
    m <- merge(i[[p]], j[[p]], by="variety", all=TRUE)
    m[is.na(m)] <- 0
    m[rev(order(m$IBS)), ]
})

par(mfrow=c(ceiling(length(k)/2), 2))
for (i in 1:2) {
   plot(k[[i]][,-1], xlab="n (IBS)", ylab="n (DAP)", 
        main=olabs[i], pch=20, col="orange", las=1)
  abline(0,1)
}
```

